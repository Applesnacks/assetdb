"use strict";require(["underscore","jquery","splunkjs/mvc","splunkjs/mvc/searchmanager","/static/app/assetdb/js/src/modal.js","/static/app/assetdb/js/src/textInput.js","/static/app/assetdb/js/src/radioInput.js","/static/app/assetdb/js/src/spinnerInput.js","/static/app/assetdb/js/src/multiselectInput.js","/static/app/assetdb/js/src/format.js","splunkjs/mvc/simpleform/input/dropdown","splunkjs/mvc/simplexml/ready!"],(function(t,e,n,a,o,s,l,i,c,d,r){var u=e("#ab_config"),p="/servicesNS/nobody/assetdb/configs/",v=n.createService();function h(t){var e=p+t;return v.get(e,{}).promise()}function f(t,e){var n=p+t;return v.post(n,e).promise()}function m(t,e,n){if("add"==n)t.push(e);else{if("delete"!=n)return;var a=t.indexOf(e);a>-1&&t.splice(a,1)}return f("conf-assetdb/general/",{lookups:t.join(",")})}function g(t,n,a,o){var s,l=[];if("add"==o){n.name=a,l.push(f("conf-assetdb/",n));var i=t.reduce((function(t,e){return"general"!==e.name&&t.push(e.name),t}),[]);-1==i.indexOf(a)&&i.push(a),i.push("_key"),i.push("asset");var c={fields_list:i.join(",")};l.push(f("conf-transforms/assetdb",c))}else if("edit"==o){var d="conf-assetdb/"+a;l.push(f(d,n))}else if("delete"==o){l.push((s=p+("conf-assetdb/"+a),v.del(s).promise()));var r=t.reduce((function(t,e){return"general"!==e.name&&t.push(e.name),t}),[]),u=r.indexOf(a);u>-1&&r.splice(u,1),r.push("_key");var h={fields_list:r.join(",")};l.push(f("conf-transforms/assetdb",h))}return e.when.apply(e,l)}function b(){var t=I();return e.when(t).then((function(t){return{search:t}})).then((function(t){return f("conf-savedsearches/assetdb-lookupgen",t)}))}function k(t,a){var d,r,u,p,v,h,f,m,k=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},y=new s({id:"inputFieldName",label:"Field Name",editable:null==k||!k.name,value:(null==k?void 0:k.name)||""}),w=new l({id:"inputKeyField",label:"Key Field",choices:[{label:"Yes",value:1},{label:"No",value:0}],value:(null==k||null===(d=k.content)||void 0===d?void 0:d.key_field)||0,help:"Key fields define a unique asset"}),_=new l({id:"inputCaseSensitive",label:"Case Sensitive",choices:[{label:"Yes",value:1},{label:"No",value:0}],value:(null==k||null===(r=k.content)||void 0===r?void 0:r.case_sensitive)||0,help:"If No, field values are converted to lowercase"}),I=new s({id:"inputIgnoreValues",label:"Ignore Values",value:(null==k||null===(u=k.content)||void 0===u?void 0:u.ignore_values)||"",help:"[Optional] A comma separated list of values to ignore"}),x=new s({id:"inputFillnull",label:"Fill Null",value:(null==k||null===(p=k.content)||void 0===p?void 0:p.fillnull)||"",help:"[Optional] Fill null entries with a static value"}),F=new l({id:"inputFieldType",label:"Field Type",choices:[{label:"Single",value:"single"},{label:"Multivalue",value:"multivalue"},{label:"Eval",value:"eval"}],value:(null==k||null===(v=k.content)||void 0===v?void 0:v.field_type)||"single",help:"Use a single value, keep all unique entries as a multivalue, or use an eval expression to define this field"}),C=new l({id:"inputMergeMethod",label:"Merge Method",choices:[{label:"Latest",value:"latest"},{label:"Coalesce",value:"coalesce"}],value:(null==k||null===(h=k.content)||void 0===h?void 0:h.merge_method)||"latest",help:"Either take the most recent value or define a precedence based on the source data"}),A=new c({id:"inputMergeOrder",label:"Merge Order",choices:t.map((function(t){return{label:t,value:t}})),value:[],help:"[Optional] Define the precedence of the source data; if no precendence is provided, a random order is used"}),E=new i({id:"inputMaxValues",label:"Max Values",value:(null==k||null===(f=k.content)||void 0===f?void 0:f.max_values)||10,help:"The maximum number of values to store as a multivalue"}),$=new s({id:"inputEvalExp",label:"Eval Expression",value:(null==k||null===(m=k.content)||void 0===m?void 0:m.eval_expression)||"",help:'An SPL eval expression, example: replace(field1, "[^w]", "")'});$form=e('\n            <div class="form-horizontal">\n                <div class="input-group-base"></div>\n                <div class="input-group-toggle input-group-single"></div>\n                <div class="input-group-toggle input-group-multivalue"></div>\n                <div class="input-group-toggle input-group-eval"></div>\n            </div>'),e(".input-group-base",$form).append(y.getInput()).append(w.getInput()).append(_.getInput()).append(I.getInput()).append(x.getInput()).append(F.getInput()),e(".input-group-single",$form).append(C.getInput()).append(A.getInput()),e(".input-group-multivalue",$form).append(E.getInput()),e(".input-group-eval",$form).append($.getInput());var N=F.getValue();e(".input-group-toggle",$form).hide(),e(".input-group-".concat(N),$form).show();var V=C.getValue(),S=A.getInput();"latest"==V?S.hide():S.show(),F.getInput().on("change",(function(t,n){e(".input-group-toggle",$form).hide(),e(".input-group-".concat(n.value),$form).show()})),C.getInput().on("change",(function(t,e){var n=A.getInput();"latest"==e.value?n.hide():n.show()}));var L=new o({wide:!0,title:k?"Edit Field":"Add Field",primaryButton:"Save",onRemove:function(){n.Components.getInstance(A.getId()).dispose()},onPrimaryBtnClick:function(){var t=this;if(y.isEditable()){if(!/^\w+$/.test(y.getValue()))return void y.setError("Field name can only use alphanumeric characters and underscores");if("asset"==y.getValue())return void y.setError('"asset" is a default field and cannot be replaced, choose another field name')}var n=y.isEditable()?"add":"edit",o={key_field:w.getValue(),case_sensitive:_.getValue(),ignore_values:I.getValue(),fillnull:x.getValue(),field_type:F.getValue(),merge_method:C.getValue(),merge_order:A.getValue(),max_values:E.getValue()||2,eval_expression:$.getValue()},s=g(a,o,y.getValue(),n);e.when(s).done((function(){b(),j("section-fields"),t.hide()}))}});L.setBody($form),L.show()}function y(t,n){var a=new o({wide:!1,title:"Delete Field",primaryButton:"Delete",onPrimaryBtnClick:function(){var a=this,o=g(t,{},n,"delete");e.when(o).done((function(){b(),j("section-fields"),a.hide()}))}}),s=e("<div>Are you sure you want to delete field <i>".concat(n,"</i>?</div>"));a.setBody(s),a.show()}function w(t){$form=e('\n            <div class="form">\n\t\t\t\t<div class="control-group shared-controls-controlgroup control-group-default">                \n\t\t\t\t\t<label class="control-label" for="control-app">App</label>                \n\t\t\t\t\t<div role="group" class="controls controls-join ">\n\t\t\t\t\t\t<div class="input-app dropdown-input"></div>\n\t\t\t\t\t</div>                                        \n\t\t\t\t</div>\n\t\t\t\t<div class="control-group shared-controls-controlgroup control-group-default">                \n\t\t\t\t\t<label class="control-label" for="control-lookup">Lookup</label>                \n\t\t\t\t\t<div role="group" class="controls controls-join ">\n\t\t\t\t\t\t<div class="input-lookup dropdown-input"></div>\n\t\t\t\t\t</div>                                        \n\t\t\t\t</div>\n            </div>'),new a({id:"searchApp",preview:!0,cache:!0,search:"| rest /services/apps/local | search disabled=0 | fields title label"},{tokens:!0}),new a({id:"searchLookup",preview:!0,cache:!0,search:"| rest /services/data/lookup-table-files | search eai:acl.app=$app$ | table title | append [| rest /services/data/transforms/lookups | search eai:acl.app=$app$ | table title] | dedup title"},{tokens:!0});new r({id:"inputApp",searchWhenChanged:!0,showClearButton:!0,selectFirstChoice:!0,labelField:"label",valueField:"title",value:"$app$",managerid:"searchApp",el:e(".input-app",$form)},{tokens:!0}).render();var s=new r({id:"inputLookup",searchWhenChanged:!0,showClearButton:!0,selectFirstChoice:!1,labelField:"title",valueField:"title",managerid:"searchLookup",el:e(".input-lookup",$form)},{tokens:!0}).render(),l=new o({wide:!1,title:"Add Lookup",primaryButton:"Save",onRemove:function(){n.Components.getInstance("inputApp").dispose(),n.Components.getInstance("inputLookup").dispose(),n.Components.getInstance("searchApp").dispose(),n.Components.getInstance("searchLookup").dispose()},onPrimaryBtnClick:function(){var n=this,a=s.val();if(a)if(t.indexOf(a)>-1)e(".input-lookup .splunk-choice-input-message div").text("The lookup file ".concat(a," has already been added."));else{var o=m(t,a,"add");e.when(o).done((function(){b(),j("section-lookups"),n.hide()}))}}});l.setBody($form),l.show()}function _(t,n){var a=t.indexOf(n);a>-1&&t.splice(a,1);var s=new o({wide:!1,title:"Remove Lookup",primaryButton:"Remove",onPrimaryBtnClick:function(){var a=this,o=m(t,n,"delete");e.when(o).done((function(){b(),j("section-lookups"),a.hide()}))}}),l=e("<div>Are you sure you want to remove asset lookup <i>".concat(n,"</i> from the merge process? Note: The lookup will still exist within Splunk.</div>"));s.setBody(l),s.show()}function j(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"section-lookups";u.html("");var n=h("conf-assetdb");e.when(n).done((function(n){var a,o=JSON.parse(n).entry,s=e('\n\t\t\t\t<div class="container">\n\t\t\t\t\t<ul class="nav nav-tabs main-tabs shared-tabcontrols-tabbar">\n\t\t\t\t\t\t<li class="shared-tabcontrols-tabbase" data-section-id="section-lookups">\n\t\t\t\t\t\t\t<a href="#" class="tab-label">Asset Lookups</a>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t\t<li class="shared-tabcontrols-tabbase" data-section-id="section-fields">            \n\t\t\t\t\t\t\t<a href="#" class="tab-label">Asset Fields</a>        \n\t\t\t\t\t\t</li>\n\t\t\t\t\t\t<li class="shared-tabcontrols-tabbase" data-section-id="section-search">            \n\t\t\t\t\t\t\t<a href="#" class="tab-label">Asset Merge Search</a>        \n\t\t\t\t\t\t</li>\n\t\t\t\t\t</ul>\n\t\t\t\t\t<section data-section-id="section-lookups">\n\t\t\t\t\t\t<p><i class="icon-info-circle"></i> Select lookup tables with asset data from individual sources to include within the merge process.</p>\n\t\t\t\t\t\t<a href="#" class="btn btn-primary btn-add-lookup">Add Lookup</a>\n\t\t\t\t\t\t<table class="lookups-table table table-striped table-chrome table-row-expanding table-hover">\n\t\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t<th>Lookup</th>\n\t\t\t\t\t\t\t\t\t<th>Action</th>\n\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t\t<tbody></tbody>\n\t\t\t\t\t\t</table>\n\t\t\t\t\t</section>\n\t\t\t\t\t<section data-section-id="section-fields">\n\t\t\t\t\t\t<p><i class="icon-info-circle"></i> Configure asset fields and how they are merged across individual lookups.</p>\n\t\t\t\t\t\t<a href="#" class="btn btn-primary btn-add-field">Add Field</a>\n\t\t\t\t\t\t<table class="fields-table table table-striped table-chrome table-row-expanding table-hover">\n\t\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t<th data-key="" class="col-info"><i class="icon-info"></i></th>\n\t\t\t\t\t\t\t\t\t<th>Field</th>\n\t\t\t\t\t\t\t\t\t<th>Field Type</th>\n\t\t\t\t\t\t\t\t\t<th>Action</th>\n\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t\t<tbody></tbody>\n\t\t\t\t\t\t</table>\n\t\t\t\t\t</section>\n\t\t\t\t\t<section data-section-id="section-search">\n\t\t\t\t\t\t<p><i class="icon-info-circle"></i> Auto generated search that merges all asset lookups according to configured fields and their respective merge settings.</p>\n\t\t\t\t\t\t<a target="_blank" href="/app/assetdb/search?s=%2FservicesNS%2Fnobody%2Fassetdb%2Fsaved%2Fsearches%2Fassetdb-lookupgen" class="btn btn-primary">Run Search <i class="icon-external"></i></a>\n\t\t\t\t\t\t<a target="_blank" href="/manager/assetdb/saved/searches?app=assetdb&search=assetdb-lookupgen" class="btn btn-edit-schedule">Edit Schedule <i class="icon-external"></i></a>\n\t\t\t\t\t\t<div class="query-container">\n\t\t\t\t\t\t\t<div class="formatted-query"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</section>\n\t\t\t\t</div>\n\t\t\t');e('li[data-section-id="'.concat(t,'"]'),s).addClass("active"),e('section[data-section-id="'.concat(t,'"]'),s).addClass("active"),e("li",s).on("click",(function(){e("li",s).removeClass("active"),e(this).addClass("active"),e("section",s).removeClass("active");var t=e(this).attr("data-section-id");e('section[data-section-id="'.concat(t,'"]'),s).addClass("active")}));var l=o.find((function(t){return"general"===t.name})),i=null!=l&&null!==(a=l.content)&&void 0!==a&&a.lookups?l.content.lookups.split(","):[];if(!i.length){var c='<p class="error-message"><i class="icon-warning"></i> WARNING: You must add at least one lookup to merge into the asset database!</p>';e('section[data-section-id="section-lookups"] p',s).last().after(c),e('section[data-section-id="section-search"] p',s).last().after(c)}if(o.length<2){var r='<p class="error-message"><i class="icon-warning"></i> WARNING: You must add at least one field to include in the asset database!</p>';e('section[data-section-id="section-fields"] p',s).last().after(r),e('section[data-section-id="section-search"] p',s).last().after(r)}e(".btn-add-field",s).on("click",(function(){return k(i,o)})),e(".btn-add-lookup",s).on("click",(function(){return w(i)})),i.forEach((function(t){var n=e('\n\t\t\t\t\t<tr data-name="'.concat(t,'">\n\t\t\t\t\t\t<td>').concat(t,'</td>\n\t\t\t\t\t\t<td><a class="adb-lookup-delete" href="#">Delete</a></td>\'}\n\t\t\t\t\t</tr>\n\t\t\t\t'));e(".adb-lookup-delete",n).on("click",(function(){return _(i,t)})),e(".lookups-table tbody",s).append(n)})),o.forEach((function(t){if("general"!=t.name){var n=parseInt(t.content.key_field),a=parseInt(t.content.case_sensitive),l=e('\n\t\t\t\t\t<tr data-name="'.concat(t.name,'">\n\t\t\t\t\t\t<td class="expands"><a href="#"><i class="icon-triangle-down-small"></i></a></td>\n\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t<span>').concat(t.name,"</span>").concat(n?'<span class="key-tag">Key</span>':"",'\n\t\t\t\t\t\t\t<div class="more-info" style="display: none">\n\t\t\t\t\t\t\t\t<dl class="list-dotted">\n\t\t\t\t\t\t\t\t\t<dt>Key Field</dt><dd>').concat(n?"Yes":"No","</dd>\n\t\t\t\t\t\t\t\t\t<dt>Case Sensitive</dt><dd>").concat(a?"Yes":"No","</dd>\n\t\t\t\t\t\t\t\t\t<dt>Ignore Values</dt><dd>").concat(t.content.ignore_values||"N/A","</dd>\n\t\t\t\t\t\t\t\t\t<dt>Fill Null</dt><dd>").concat(t.content.fillnull||"N/A","</dd>\n\t\t\t\t\t\t\t\t</dl>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\t<td>").concat(t.content.field_type,'</td>\n\t\t\t\t\t\t<td><a class="adb-field-edit" href="#">Edit</a> | <a class="adb-field-delete" href="#">Delete</a></td>\'}\n\t\t\t\t\t</tr>')),c=e("dl",l);"single"==t.content.field_type?(c.append("<dt>Merge Method</dt><dd>".concat(t.content.merge_method,"</dd>")),"coalesce"==t.content.merge_method&&c.append("<dt>Merge Order</dt><dd>".concat(t.content.merge_order,"</dd>"))):"multivalue"==t.content.field_type?c.append("<dt>Max Values</dt><dd>".concat(t.content.max_values,"</dd>")):"eval"==t.content.field_type&&c.append("<dt>Eval Expression</dt><dd>".concat(t.content.eval_expression,"</dd>")),e("td.expands",l).on("click",(function(){return e(this).next().find(".more-info").toggle(),e("i",this).toggleClass("icon-triangle-right-small").toggleClass("icon-triangle-down-small"),!1})),e(".adb-field-edit",l).on("click",(function(){return k(i,o,t)})),e(".adb-field-delete",l).on("click",(function(){return y(o,t.name)})),e(".fields-table tbody",s).append(l)}}));var p=I(o);e.when(p).done((function(t){var n=d(t,!0,!0);e(".formatted-query",s).append(n)})),u.append(s)}))}function I(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=t.length?e.Deferred().resolve().promise():h("conf-assetdb");return e.when(n).then((function(e){t.length||(t=JSON.parse(e).entry);var n=[],a=[],o=[],s=[],l=[],i=[],c=[],d=[],r=[],u=[],p=[],v=[];t.forEach((function(t){var e;if("general"==t.name&&null!=t&&null!==(e=t.content)&&void 0!==e&&e.lookups){var h=t.content.lookups.split(",");v=h.map((function(t){return"\n| `append_adb_lookup(".concat(t,")`")}))}else{var f;if(parseInt(t.content.key_field)&&i.push(t.name),t.content.ignore_values){var m=t.content.ignore_values.split(",").map((function(t){return'"'.concat(t,'"')}));r.push("".concat(t.name," = if(in(").concat(t.name,", ").concat(m.join(", "),"), null(), ").concat(t.name,")"))}if(null!=t&&null!==(f=t.content)&&void 0!==f&&f.fillnull&&d.push("".concat(t.name," = if(isnull(").concat(t.name,'), "').concat(t.content.fillnull,'", ').concat(t.name,")")),parseInt(t.content.case_sensitive)||u.push("".concat(t.name," = lower(").concat(t.name,")")),"single"==t.content.type){if("latest"==t.content.merge_method)s.push("latest(".concat(t.name,") as ").concat(t.name));else if("coalesce"==t.content.merge_method){n.push("{adb_source}_".concat(t.name," = ").concat(t.name));var g=t.content.merge_order.split(","),b=g.map((function(e){return"latest(".concat(e,"_").concat(t.name,") as ").concat(e,"_").concat(t.name)}));s=s.concat(b);var k=g.map((function(e){return"'".concat(e,"_").concat(t.name,"'")}));a.push("".concat(t.name," = coalesce(").concat(k.join(", "),")"))}}else"multivalue"==t.content.type?(o.push(t.name),s.push("values(".concat(t.name,") as ").concat(t.name)),p.push("".concat(t.name," = mvindex(").concat(t.name,",0,").concat(parseInt(t.content.max_values)-1,")"))):"eval"==t.content.type&&l.push("".concat(t.name," = ").concat(t.content.eval_expression));c.push(t.name)}}));var h="| makeresults";return v.length&&(h+=v.join("")),h+='\n| foreach * [eval <<FIELD>>=split(<<FIELD>>, "|")]',u.length&&(h+="\n| eval ".concat(u.join(", "))),r.length&&(h+="\n| eval ".concat(r.join(", "))),d.length&&(h+="\n| eval ".concat(d.join(", "))),n.length&&(h+="\n| eval ".concat(n.join(", "))),l.length&&(h+="\n| eval ".concat(l.join(", "))),i.forEach((function(t){var e=[];i.forEach((function(n){t!=n&&e.push("values(".concat(n,") as key_").concat(n))})),h+="\n| eventstats ".concat(e.join(" ")," by ").concat(t)})),h+="\n| eval asset = mvappend(".concat(i.join(", "),")"),h+='\n| eval _key = mvjoin(asset), "::")',s.length&&(h+="\n| stats values(asset) as asset ".concat(s.join(", ")," by _key")),p.length&&(h+="\n| eval ".concat(p.join(", "))),a.length&&(h+="\n| eval ".concat(a.join(", "))),h+="\n| table _key, asset, ".concat(c.join(", ")),h+="\n| outputlookup assetdb"}))}j()}));