"use strict";require(["underscore","jquery","splunkjs/mvc","splunkjs/mvc/searchmanager","/static/app/assetdb/js/src/modal.js","/static/app/assetdb/js/src/textInput.js","/static/app/assetdb/js/src/radioInput.js","/static/app/assetdb/js/src/spinnerInput.js","/static/app/assetdb/js/src/multiselectInput.js","/static/app/assetdb/js/src/format.js","splunkjs/mvc/simplexml/ready!"],(function(t,e,n,a,l,o,i,s,c,d){$el=e("#ab_config");var r="/servicesNS/nobody/assetdb/configs/",u=n.createService();function p(t,e){var n=r+t;return u.post(n,e,(function(t,e){})).promise()}function v(){var t,a,d,r,u,v,g,m,f,b,y=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=new o({id:"inputFieldName",label:"Field Name",editable:null==y||!y.name,value:(null==y?void 0:y.name)||""}),_=new i({id:"inputKeyField",label:"Key Field",choices:[{label:"Yes",value:1},{label:"No",value:0}],value:(null==y||null===(t=y.content)||void 0===t?void 0:t.key_field)||0,help:"Key fields define a unique asset"}),w=new i({id:"inputCaseSensitive",label:"Case Sensitive",choices:[{label:"Yes",value:1},{label:"No",value:0}],value:(null==y||null===(a=y.content)||void 0===a?void 0:a.case_sensitive)||0,help:"If No, field values are converted to lowercase"}),I=new o({id:"inputIgnoreValues",label:"Ignore Values",value:(null==y||null===(d=y.content)||void 0===d?void 0:d.ignore_values)||"",help:"[Optional] A comma separated list of values to ignore"}),j=new o({id:"inputFillnull",label:"Fill Null",value:(null==y||null===(r=y.content)||void 0===r?void 0:r.fillnull)||"",help:"[Optional] Fill null entries with a static value"}),x=new i({id:"inputType",label:"Type",choices:[{label:"Single",value:"single"},{label:"Multivalue",value:"multivalue"},{label:"Eval",value:"eval"}],value:(null==y||null===(u=y.content)||void 0===u?void 0:u.type)||"single",help:"Use a single value, keep all unique entries as a multivalue, or use an eval expression to define this field"});parseInt(null==y||null===(v=y.content)||void 0===v?void 0:v.key_field)&&x.disable();var V=new i({id:"inputMergeMethod",label:"Merge Method",choices:[{label:"Latest",value:"latest"},{label:"Coalesce",value:"coalesce"}],value:(null==y||null===(g=y.content)||void 0===g?void 0:g.merge_method)||"latest",help:"Either take the most recent value or define a precedence based on the source data"}),A=new c({id:"inputMergeOrder",label:"Merge Order",choices:[{label:"test1",value:"test1"},{label:"test2",value:"test2"},{label:"test3",value:"test3"}],value:(null==y||null===(m=y.content)||void 0===m?void 0:m.merge_order)||[],help:"[Optional] Define the precedence of the source data; if no precendence is provided, a random order is used"}),F=new s({id:"inputMaxValues",label:"Max Values",value:(null==y||null===(f=y.content)||void 0===f?void 0:f.max_values)||10,help:"The maximum number of values to store as a multivalue"}),E=new o({id:"inputEvalExp",label:"Eval Expression",value:(null==y||null===(b=y.content)||void 0===b?void 0:b.eval_expression)||"",help:'An SPL eval expression, example: replace(field1, "[^w]", "")'});$form=e('\n            <div class="form-horizontal">\n                <div class="input-group-base"></div>\n                <div class="input-group-toggle input-group-single"></div>\n                <div class="input-group-toggle input-group-multivalue"></div>\n                <div class="input-group-toggle input-group-eval"></div>\n            </div>'),e(".input-group-base",$form).append(k.getInput()).append(_.getInput()).append(w.getInput()).append(I.getInput()).append(j.getInput()).append(x.getInput()),e(".input-group-single",$form).append(V.getInput()).append(A.getInput()),e(".input-group-multivalue",$form).append(F.getInput()),e(".input-group-eval",$form).append(E.getInput());var M=x.getValue();e(".input-group-toggle",$form).hide(),e(".input-group-".concat(M),$form).show();var C=V.getValue(),$=A.getInput();"latest"==C?$.hide():$.show(),_.getInput().on("change",(function(t,e){"1"==e.value?(x.setValue("single"),x.disable()):x.enable()})),x.getInput().on("change",(function(t,n){e(".input-group-toggle",$form).hide(),e(".input-group-".concat(n.value),$form).show()})),V.getInput().on("change",(function(t,e){var n=A.getInput();"latest"==e.value?n.hide():n.show()}));var N=new l({wide:!0,title:y?"Edit Field":"Add Field",primaryButton:"Save",onRemove:function(){n.Components.getInstance(A.getId()).dispose()},onPrimaryBtnClick:function(){var t=this;if(k.isEditable()){if(!/^\w+$/.test(k.getValue()))return void k.setError("Field name can only use alphanumeric characters and underscores")}var n="conf-assetdb/",a={key_field:_.getValue(),case_sensitive:w.getValue(),ignore_values:I.getValue(),fillnull:j.getValue(),type:x.getValue(),merge_method:V.getValue(),merge_order:A.getValue(),max_values:F.getValue()||2,eval_expression:E.getValue()};k.isEditable()?a.name=k.getValue():n+=k.getValue();var l=p(n,a);e.when(l).done((function(){h(),t.hide()}))}});N.setBody($form),N.show()}function g(t){var n=new l({wide:!1,title:"Delete Field",primaryButton:"Delete",onPrimaryBtnClick:function(){var n=this,a=function(t){var e=r+t,n=u.del(e,(function(t,e){n.resolve(e)}));return n.promise()}("conf-assetdb/"+t);e.when(a).done((function(){h(),n.hide()}))}}),a=e("<div>Are you sure you want to delete field <i>".concat(t,"</i>?</div>"));n.setBody(a),n.show()}function h(){$el.html("");var t,n=(t=r+"conf-assetdb",u.get(t,{},(function(t,e){})).promise());e.when(n).done((function(t){var n=JSON.parse(t).entry,a=e('\n\t\t\t\t<ul class="nav nav-tabs main-tabs shared-tabcontrols-tabbar">\n\t\t\t\t\t<li class="shared-tabcontrols-tabbase active" data-section-id="section-lookups">\n\t\t\t\t\t\t<a href="#" class="tab-label">Asset Lookups</a>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li data-cid="view345" class="shared-tabcontrols-tabbase" data-section-id="section-fields">            \n\t\t\t\t\t\t<a href="#" class="tab-label">Asset Fields</a>        \n\t\t\t\t\t</li>\n\t\t\t\t\t<li data-cid="view346" class="shared-tabcontrols-tabbase" data-section-id="section-search">            \n\t\t\t\t\t\t<a href="#" class="tab-label">Asset Merge Search</a>        \n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t\t<section id="section-lookups" class="active">\n\t\t\t\t\t<h2>Asset Lookups <i class="icon-info-circle" data-toggle="tooltip" title="Select lookup tables with asset data from individual sources to include within the merge process."></i></h2>\n\t\t\t\t\t<a href="#" class="btn btn-primary btn-add-field">Add Lookup</a>\n\t\t\t\t\t<table class="lookups-table table table-striped table-chrome table-row-expanding table-hover">\n\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<th>Lookup</th>\n\t\t\t\t\t\t\t\t<th>Action</th>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t<tbody></tbody>\n\t\t\t\t\t</table>\n\t\t\t\t</section>\n\t\t\t\t<section id="section-fields">\n\t\t\t\t\t<h2>Asset Fields <i class="icon-info-circle" data-toggle="tooltip" title="Configure asset fields and how they are merged across individual lookups."></i></h2>\n\t\t\t\t\t<a href="#" class="btn btn-primary btn-add-field">Add Field</a>\n\t\t\t\t\t<table class="fields-table table table-striped table-chrome table-row-expanding table-hover">\n\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<th data-key="" class="col-info"><i class="icon-info"></i></th>\n\t\t\t\t\t\t\t\t<th>Field</th>\n\t\t\t\t\t\t\t\t<th>Type</th>\n\t\t\t\t\t\t\t\t<th>Action</th>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t<tbody></tbody>\n\t\t\t\t\t</table>\n\t\t\t\t</section>\n\t\t\t\t<section id="section-search">\n\t\t\t\t\t<h2>Asset Merge Search <i class="icon-info-circle" data-toggle="tooltip" title="Auto generated search that merges all asset lookups according to configured fields and their respective merge settings."></i></h2>\n\t\t\t\t\t<a href="#" class="btn btn-primary btn-add-field">Run Search</a>\n\t\t\t\t\t<div class="query-container">\n\t\t\t\t\t\t<textarea class="raw-query"></textarea>\n\t\t\t\t\t\t<div class="formatted-query"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</section>\n\t\t\t');e("ul li",a).on("click",(function(){console.log("clicked"),e(".nav-tabs li",a).removeClass("active"),e(this).addClass("active"),e("section",a).removeClass("active"),e("#".concat(e(this).attr("data-section-id")),a).addClass("active")})),e(".btn-add-field",a).on("click",(function(){return v()})),n.forEach((function(t){if("general"==t.name){var n;if(null==t||null===(n=t.content)||void 0===n||!n.lookups)return;t.content.lookups.split(",").forEach((function(t){var n=e('\n\t\t\t\t\t\t\t<tr data-name="'.concat(t,'">\n\t\t\t\t\t\t\t\t<td>').concat(t,'</td>\n\t\t\t\t\t\t\t\t<td><a class="adb-field-delete" href="#">Delete</a></td>\'}\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t'));e(".lookups-table tbody",a).append(n)}))}else{var l=parseInt(t.content.key_field),o=parseInt(t.content.case_sensitive),i=e('\n\t\t\t\t\t\t<tr data-name="'.concat(t.name,'">\n\t\t\t\t\t\t\t<td class="expands"><a href="#"><i class="icon-triangle-down-small"></i></a></td>\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t<span>').concat(t.name,"</span>").concat(l?'<span class="key-tag">Key</span>':"",'\n\t\t\t\t\t\t\t\t<div class="more-info" style="display: none">\n\t\t\t\t\t\t\t\t\t<dl class="list-dotted">\n\t\t\t\t\t\t\t\t\t\t<dt>Key Field</dt><dd>').concat(l?"Yes":"No","</dd>\n\t\t\t\t\t\t\t\t\t\t<dt>Case Sensitive</dt><dd>").concat(o?"Yes":"No","</dd>\n\t\t\t\t\t\t\t\t\t\t<dt>Ignore Values</dt><dd>").concat(t.content.ignore_values||"N/A","</dd>\n\t\t\t\t\t\t\t\t\t\t<dt>Fill Null</dt><dd>").concat(t.content.fillnull||"N/A","</dd>\n\t\t\t\t\t\t\t\t\t</dl>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t<td>").concat(t.content.type,'</td>\n\t\t\t\t\t\t\t<td><a class="adb-field-edit" href="#">Edit</a> | <a class="adb-field-delete" href="#">Delete</a></td>\'}\n\t\t\t\t\t\t</tr>')),s=e("dl",i);"single"==t.content.type?(s.append("<dt>Merge Method</dt><dd>".concat(t.content.merge_method,"</dd>")),"coalesce"==t.content.merge_method&&s.append("<dt>Merge Order</dt><dd>".concat(t.content.merge_order,"</dd>"))):"multivalue"==t.content.type?s.append("<dt>Max Values</dt><dd>".concat(t.content.max_values,"</dd>")):"eval"==t.content.type&&s.append("<dt>Eval Expression</dt><dd>".concat(t.content.eval_expression,"</dd>")),e("td.expands",i).on("click",(function(){return e(this).next().find(".more-info").toggle(),e("i",this).toggleClass("icon-triangle-right-small").toggleClass("icon-triangle-down-small"),!1})),e(".adb-field-edit",i).on("click",(function(){return v(t)})),e(".adb-field-delete",i).on("click",(function(){return g(t.name)})),e(".fields-table tbody",a).append(i)}}));var l=function(t){var e=[],n=[],a=[],l=[],o=[],i=[],s={},c=[],d=[],r=[],u=[];t.forEach((function(t){var p;if("general"==t.name&&null!=t&&null!==(p=t.content)&&void 0!==p&&p.lookups){var v=t.content.lookups.split(",");console.log(v),u=v.map((function(t){return"\n| `append_adb_lookup(".concat(t,")`")}))}else{if(parseInt(t.content.key_field)&&o.push(t.name),t.content.ignore_values){var g=t.content.ignore_values.split(",").map((function(t){return'"'.concat(t,'"')}));c.push("".concat(t.name," = if(in(").concat(t.name,", ").concat(g.join(", "),"), null(), ").concat(t.name,")"))}if(t.content.fillnull){var h=t.content.fillnull;h in s?s[h].push(t.name):s[h]=[t.name]}if(parseInt(t.content.case_sensitive)||d.push("".concat(t.name," = lower(").concat(t.name,")")),"single"==t.content.type){if("latest"==t.content.merge_method)a.push("latest(".concat(t.name,") as ").concat(t.name));else if("coalesce"==t.content.merge_method){e.push("{adb_source}_".concat(t.name," = ").concat(t.name));var m=t.content.merge_order.split(","),f=m.map((function(e){return"latest(".concat(e,"_").concat(t.name,") as ").concat(e,"_").concat(t.name)}));a=a.concat(f);var b=m.map((function(e){return"".concat(e,"_").concat(t.name)}));n.push("".concat(t.name," = coalesce(").concat(b.join(", "),")"))}}else"multivalue"==t.content.type?(a.push("values(".concat(t.name,") as ").concat(t.name)),r.push("".concat(t.name," = mvindex(").concat(t.name,",0,").concat(parseInt(t.content.max_values)-1,")"))):"eval"==t.content.type&&l.push("".concat(t.name," = ").concat(t.content.eval_expression));i.push(t.name)}}));var p="| makeresults";u.length&&(p+=u.join(""));d.length&&(p+="\n| eval ".concat(d.join(", ")));c.length&&(p+="\n| eval ".concat(c.join(", ")));o.length&&(p+="\n| eval _key = ".concat(o.join(".")));for(k in s)p+="\n| fillnull ".concat(s[k].join(" "),' value="').concat(k,'"');e.length&&(p+="\n| eval ".concat(e.join(", ")));p+="\n| stats ".concat(a.join(", ")," by _key"),r.length&&(p+="\n| eval ".concat(r.join(", ")));n.length&&(p+="\n| eval ".concat(n.join(", ")));l.length&&(p+="\n| eval ".concat(l.join(", ")));return p+="\n| table _key, ".concat(i.join(", "))}(n),o=d(l,!0,!0);e(".raw-query",a).val(l),e(".formatted-query",a).append(o),$el.append(a)}))}h()}));